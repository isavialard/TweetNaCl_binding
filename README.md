# TweetNaCl_binding

This is a binding in Ada and SPARK of the C crypto-library [TweetNaCl](http://tweetnacl.cr.yp.to/index.html) by Prof Daniel J. Bernstein et al.

## Low level binding

The package tweetnacl_binding.ads is a low level binding used as an interface between C and Ada. It was generated using the  Ada spec dump compiler, then modified in order to avoid using pointers to pass the arguments. More types were created to take advantage of Ada strong typing, and the functions declared have been limited by pre- and post-conditions to ensure they are used with array of the right sizes, and sometimes padded with zeros on the first 32 bytes.

## High level binding

The package tweetnacl_interface.ads and tweetnacl_interface.adb is a higher level binding than tweetnacl_binding.ads, which comply with the limitations enforced by SPARK. Thus one can use the SPARK tools for formal verification. They can check if the programs declared in tweetnaclhl.ads are used as they are meant to be, with the right arguments and in the right order.

## Description of the programs

### To encrypt and decrypt

Crypto_box encrypts and authenticates a message m using a nonce n (which should be generated by randombytes and used only for this message) the sender's secret key and the receiver's public key (which must be generated by crypto_box_keypair). It returns the resulting ciphertext c. 

Crypto_box_open verifies and decrypts a ciphertext c using the nonce n, the sender's public pk and the reciever's secret key sk. It returns the resulting plaintext m. It prints out "error crypto_box_open" if c fails the authentication.

Crypto_box_keypair randomly generates a secret key sk and the corresponding public key pk to be used with crypto_box and crypto_box_open.

### To sign and verify the signature

Crypto_sign signs a message m using the signer's secret key sk (which must be generated by crypto_sign_keypair). It returns the resulting signed message sm.

Crypto_sign_open verifies the signature in sm using the signer's public key pk (which must be generated by crypto_sign_keypair with the secret_key that was used to signed the message in the first place). It returns the initial message m. It prints out "error crypto_sign_open" if the signature fails the verification.

Crypto_sign_keypair generates a secret key sk and the corresponding public key pk to be used with crypto_sign and crypto_sign_open.

### Other programs

Randombytes can be used to randomly generate a Key or a Nonce.

The other programs declared in tweetnacl_interface.ads are the basic components of these six main procedures. If you want to use these other programs in a different way than tweetnacl.c, then the pre- and post-conditions in tweetnacl_interface.ads could be an hindrance. That could mean that what you are trying to do is unsafe, but if you want to keep trying you should consider calling directly the functions declared in the low-level binding tweetnacl_binding.ads.

### Ghost functions

Ghost functions like isSigned always return 0, thus the Pre- and Post-conditions they are called in are always valid : they have no influence during the execution. They are only useful with the proof stage of formal verification, where they check if the right arguments are used in the right way. For instance a Nonce has to be only used once, or a message has to be signed before being encrypted and not the other way around, in order to prove that these Pre-conditions are always valid.

## Tests

Test1.adb uses the six main procedure of tweetnacl to send a message from Alice to Bob. Alice generates a key pair to sign her message and make the public key public. Bob and Alice both generates keypairs for encryption, and the public keys are public as well. To send a message, Alice has to generate randomly a Nonce with randombytes, then sign and encrypt her message with Crypto_Sign and Crypto_Box. She sends her cipher text and her Nonce to Bob, which decrypts it with Crypto_Box_Open, and verifies it came from Alice with Crypto_Sign.
Test1b.adb is the same as Test1 with one more step to show how Alice and Bob are able to create a common shared key from their secret key and the other's public key.

Tests 2 to 5 are copies of test.adb with some mistakes or bad practices, which are caught by the pre- and post-conditions, and cause failure either at execution or during SPARK proof.
